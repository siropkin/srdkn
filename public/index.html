<!doctype html>
<html lang="en">
<head>
    <title>SRDKN</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="index.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f8ff;
            padding: 20px;
        }

        #weather, #outfit {
            margin-bottom: 20px;
        }

        img {
            max-width: 100%;
            height: auto;
        }
    </style>
</head>
<body>
<header>
    <h1>SRDKN</h1>
</header>
<main>
    <p id="error"></p>

    <div id="weather">
        <h2>Current Weather:</h2>
        <p id="weatherData">Fetching weather data...</p>
    </div>

    <div id="outfit">
        <h2>Suggested Outfit:</h2>
        <p id="outfitText">Awaiting outfit suggestion...</p>
        <img id="outfitImage" src="" alt="Outfit Image" style="display:none;">
    </div>
</main>
<footer>
    <p>2024</p>
</footer>
<!-- <script src="./components/map.js"></script> -->
<script>
  const OPENWEATHER_API_KEY = 'dd0714c003f5f1d123825a96b72c1275';
  const OPENWEATHER_API_URL = `https://api.openweathermap.org/data/2.5/weather?q=Annapolis,USA&APPID=${OPENWEATHER_API_KEY}&units=metric`;

  const OPENAI_API_KEY = 'sk-qR0_vP_60x47fK9Hxq3XlCShZpi2NV1knkY3KvwfQDT3BlbkFJm5aiakYtS8JzEOgKYovfRuHQARDpPazuKStkXfh8oA';
  const OPENAI_API_CHAT_URL = 'https://api.openai.com/v1/chat/completions';
  const OPENAI_API_IMG_URL = 'https://api.openai.com/v1/images/generations';

  async function fetchWeather() {
    try {
      const response = await fetch(OPENWEATHER_API_URL);
      const data = await response.json();
      displayWeather(data);
      await fetchOutfitSuggestion(data);
    } catch (error) {
      document.getElementById('error').innerText = `Ups, something went wrong: ${error.message}`;
    }
  }

  function displayWeather(data) {
    const weatherText = `City: ${data.name}, Weather: ${data.weather[0].description}, Temperature: ${data.main.temp}Â°C`;
    document.getElementById('weatherData').innerText = weatherText;
  }

  async function fetchOutfitSuggestion(weatherData) {
    const prompt = `Based on this weather data, suggest an outfit I should wear today. The suggestions should be written in one-sentence style: ${JSON.stringify(weatherData)}`;

    try {
      const response = await fetch(OPENAI_API_CHAT_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${OPENAI_API_KEY}`,
        },
        body: JSON.stringify({
          model: "gpt-4o-mini",
          messages: [{role: "user", content: prompt}],
          temperature: 0.7
        })
      });

      const data = await response.json();
      if (data.error) {
        document.getElementById('error').innerText = `Ups, something went wrong: ${data.error.message}`;
      } else {
        displayOutfitSuggestion(data);
        await fetchOutfitImage(data);
      }
    } catch (error) {
      document.getElementById('error').innerText = `Ups, something went wrong: ${error.message}`;
    }
  }

  function displayOutfitSuggestion(data) {
    const outfitSuggestion = data.choices[0].message.content;
    document.getElementById('outfitText').innerText = outfitSuggestion;
  }

  async function fetchOutfitImage(outfitData) {
    const prompt = `Based on this weather data, draw a photo-realistic picture of a outfit a man should wear today: ${outfitData.choices[0].message.content}`;

    try {
      const response = await fetch(OPENAI_API_IMG_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${OPENAI_API_KEY}`,
        },
        body: JSON.stringify({
          model: "dall-e-3",
          prompt: prompt,
        })
      });

      const data = await response.json();

      if (data.error) {
        document.getElementById('error').innerText = `Ups, something went wrong: ${data.error.message}`;
      } else {
        displayOutfitImage(data);
      }
    } catch (error) {
      document.getElementById('error').innerText = `Ups, something went wrong: ${error.message}`;
    }
  }

  function displayOutfitImage(data) {
    const outfitImage = data.data[0].url;
    document.getElementById('outfitImage').src = outfitImage;
    document.getElementById('outfitImage').style.display = 'block';
  }

  // Initialize app by fetching the weather
  fetchWeather();
</script>
</body>
</html>
